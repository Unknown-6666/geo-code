<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveBot - Discord Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        :root {
            --discord-dark: #36393f;
            --discord-darker: #2f3136;
            --discord-light: #dcddde;
            --discord-sidebar: #202225;
            --discord-channel: #2f3136;
            --discord-selected: #4f545c;
            --discord-highlight: #5865f2;
            --discord-message: #40444b;
        }
        
        body {
            background-color: var(--discord-dark);
            color: var(--discord-light);
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            background-color: var(--discord-sidebar);
            height: 100vh;
            overflow-y: auto;
            padding-top: 15px;
        }
        
        .channel-list {
            background-color: var(--discord-channel);
            height: 100vh;
            overflow-y: auto;
            padding-top: 15px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .message-area {
            height: calc(100vh - 60px);
            overflow-y: auto;
            padding: 15px;
        }
        
        .channel-header {
            background-color: var(--discord-dark);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
        }
        
        .message-input {
            background-color: var(--discord-message);
            border-radius: 8px;
            color: var(--discord-light);
            padding: 10px 15px;
            margin: 10px;
        }
        
        .server-icon {
            width: 48px;
            height: 48px;
            background-color: var(--discord-highlight);
            border-radius: 50%;
            margin: 5px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }
        
        .channel-item {
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
            margin: 2px 5px;
        }
        
        .channel-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .channel-item.active {
            background-color: var(--discord-selected);
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            background-color: #7289da;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .message-content {
            flex: 1;
        }
        
        .message-author {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .message-text {
            word-break: break-word;
        }
        
        .message-timestamp {
            font-size: 0.75rem;
            color: #72767d;
            margin-left: 10px;
        }
        
        .user-area {
            background-color: var(--discord-darker);
            padding: 10px;
            position: fixed;
            bottom: 0;
            width: inherit;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Status indicators */
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .status-online {
            background-color: #43b581;
        }
        
        .status-idle {
            background-color: #faa61a;
        }
        
        .status-dnd {
            background-color: #f04747;
        }
        
        .status-offline {
            background-color: #747f8d;
        }
        
        /* Server and member lists */
        .server-list, .member-list {
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        
        /* Member item */
        .member-item {
            padding: 8px 15px;
            display: flex;
            align-items: center;
            border-radius: 4px;
            margin: 2px 5px;
        }
        
        .member-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #202225;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-0">
        <div class="row g-0">
            <!-- Server sidebar -->
            <div class="col-auto sidebar">
                <div class="server-icon" data-bs-toggle="tooltip" data-bs-placement="right" title="Home">
                    <i class="bi bi-discord"></i>
                </div>
                <hr class="my-2" style="border-color: rgba(255, 255, 255, 0.1);">
                <div id="server-list" class="server-list">
                    <!-- Server icons will be dynamically loaded here -->
                    <div class="text-center p-3 text-muted">
                        <small>Loading servers...</small>
                    </div>
                </div>
            </div>
            
            <!-- Channel list -->
            <div class="col-auto channel-list" style="width: 240px;">
                <div class="d-flex justify-content-between px-3">
                <h6 class="text-uppercase text-muted fs-6 fw-bold">Channels</h6>
                <button id="dm-button" class="btn btn-sm btn-outline-secondary" title="Direct Messages">
                    <i class="bi bi-envelope"></i>
                </button>
            </div>
                <div id="channel-list">
                    <!-- Channels will be dynamically loaded here -->
                    <div class="text-center p-3 text-muted">
                        <small>Select a server to view channels</small>
                    </div>
                </div>
            </div>
            
            <!-- Main chat area -->
            <div class="col">
                <!-- Channel header -->
                <div class="channel-header d-flex align-items-center">
                    <i class="bi bi-hash me-2"></i>
                    <span id="current-channel">Welcome to LiveBot</span>
                </div>
                
                <!-- Message area -->
                <div class="message-area" id="message-area">
                    <div class="text-center p-4">
                        <div class="mb-3">
                            <i class="bi bi-discord" style="font-size: 3rem;"></i>
                        </div>
                        <h4>Welcome to LiveBot</h4>
                        <p class="text-muted">Select a server and channel to view messages</p>
                    </div>
                </div>
                
                <!-- Message input -->
                <div class="d-flex align-items-center">
                    <input type="text" id="message-input" class="form-control message-input" placeholder="Send a message..." disabled>
                    <button id="send-button" class="btn btn-primary mx-2" disabled>
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
            
            <!-- Member list -->
            <div class="col-auto d-none d-lg-block" style="width: 240px; background-color: var(--discord-channel);">
                <h6 class="text-uppercase px-3 pt-3 text-muted fs-6 fw-bold">Members</h6>
                <div id="member-list" class="member-list">
                    <!-- Members will be dynamically loaded here -->
                    <div class="text-center p-3 text-muted">
                        <small>Select a channel to view members</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot status area (fixed at bottom of sidebar) -->
    <div class="user-area">
        <div class="d-flex align-items-center">
            <div class="status-indicator status-online"></div>
            <div class="ms-2">
                <div class="fw-bold" id="bot-username">Bot</div>
                <div class="text-muted small">Online</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Set up event listeners
            setupEventListeners();
            
            // Load bot information
            loadBotInfo();
            
            // Load servers
            loadServers();
        });
        
        // Helper function to show error messages in the LiveBot interface
        function showErrorDisplay(title, message) {
            const messageArea = document.getElementById('message-area');
            
            // Check if error display already exists
            const existingError = document.getElementById('error-display');
            if (existingError) {
                existingError.remove();
            }
            
            // Create error display
            const errorDisplay = document.createElement('div');
            errorDisplay.id = 'error-display';
            errorDisplay.className = 'text-center p-4';
            errorDisplay.innerHTML = `
                <div class="mb-3">
                    <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 3rem;"></i>
                </div>
                <h4 class="text-danger">${title}</h4>
                <p class="text-muted">${message}</p>
                <button id="retry-connection" class="btn btn-outline-primary mt-3">
                    <i class="bi bi-arrow-clockwise"></i> Retry Connection
                </button>
            `;
            
            // Add to message area
            messageArea.innerHTML = '';
            messageArea.appendChild(errorDisplay);
            
            // Add retry event listener
            document.getElementById('retry-connection').addEventListener('click', function() {
                // Reload bot info and servers
                loadBotInfo();
                loadServers();
            });
        }
        
        // Helper function to clear error messages
        function clearErrorDisplay() {
            const errorDisplay = document.getElementById('error-display');
            if (errorDisplay) {
                errorDisplay.remove();
            }
        }
        
        function setupEventListeners() {
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const dmButton = document.getElementById('dm-button');
            const messageArea = document.getElementById('message-area');
            
            // Send message when Enter key is pressed in the input field
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Send message when send button is clicked
            sendButton.addEventListener('click', sendMessage);
            
            // Load DMs when DM button is clicked
            dmButton.addEventListener('click', loadDMChannels);
            
            // Add event listener for loading older messages when scrolling to top
            messageArea.addEventListener('scroll', function() {
                if (messageArea.scrollTop === 0) {
                    const channelId = messageInput.getAttribute('data-channel-id');
                    if (channelId) {
                        const messages = document.querySelectorAll('.message');
                        if (messages.length > 0) {
                            const oldestMessage = messages[0];
                            const oldestMessageId = oldestMessage.getAttribute('data-message-id');
                            loadOlderMessages(channelId, oldestMessageId);
                        }
                    }
                }
            });
        }
        
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            const channelId = messageInput.getAttribute('data-channel-id');
            const channelType = messageInput.getAttribute('data-channel-type') || 'regular';
            
            if (content && channelId) {
                // Clear the input field
                messageInput.value = '';
                
                // Show a temporary message (optimistic UI)
                addMessage({
                    id: 'temp-' + Date.now(),
                    content: content,
                    author: {
                        username: document.getElementById('bot-username').textContent,
                        avatarUrl: null
                    },
                    timestamp: new Date().toISOString(),
                    pending: true
                });
                
                // Determine if this is a DM or regular channel message
                let endpoint = '/api/send_message';
                let payload = {
                    channel_id: channelId,
                    content: content
                };
                
                if (channelType === 'dm') {
                    endpoint = '/api/send_dm';
                    payload = {
                        user_id: messageInput.getAttribute('data-recipient-id'),
                        content: content
                    };
                }
                
                // Send the message to the server
                fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        console.error('Error sending message:', data.message);
                        // Show error to user
                        showNotification('Error sending message: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Failed to send message. Check your connection.', 'danger');
                });
            }
        }
        
        function loadDMChannels() {
            // Change the channel list heading
            document.querySelector('.channel-list .d-flex h6').innerText = 'DIRECT MESSAGES';
            
            // Remove active state from all servers
            document.querySelectorAll('.server-icon').forEach(server => {
                server.classList.remove('active');
            });
            
            // Empty the message area
            document.getElementById('message-area').innerHTML = `
                <div class="text-center p-4">
                    <div class="mb-3">
                        <i class="bi bi-envelope" style="font-size: 3rem;"></i>
                    </div>
                    <h4>Direct Messages</h4>
                    <p class="text-muted">Select a user to view your private conversation</p>
                </div>
            `;
            
            // Load DM channels from API
            fetch('/api/dm_channels')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const channelList = document.getElementById('channel-list');
                        channelList.innerHTML = '';
                        
                        if (data.dm_channels.length === 0) {
                            channelList.innerHTML = `
                                <div class="text-center p-3 text-muted">
                                    <small>No direct messages found</small>
                                </div>
                            `;
                            return;
                        }
                        
                        // Create DM channel list
                        data.dm_channels.forEach(dmChannel => {
                            const channelElement = document.createElement('div');
                            channelElement.className = 'channel-item';
                            channelElement.setAttribute('data-channel-id', dmChannel.id);
                            channelElement.setAttribute('data-recipient-id', dmChannel.recipient.id);
                            
                            // Create avatar or initial
                            let avatarHtml = '';
                            if (dmChannel.recipient.avatar_url) {
                                avatarHtml = `<img src="${dmChannel.recipient.avatar_url}" alt="${dmChannel.recipient.username}" class="rounded-circle me-2" width="24" height="24">`;
                            } else {
                                const initial = dmChannel.recipient.username.charAt(0).toUpperCase();
                                avatarHtml = `<span class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px;">${initial}</span>`;
                            }
                            
                            // Add bot badge if recipient is a bot
                            const botBadge = dmChannel.recipient.is_bot ? 
                                '<span class="badge bg-primary ms-1">BOT</span>' : '';
                            
                            channelElement.innerHTML = `
                                ${avatarHtml} ${dmChannel.recipient.username} ${botBadge}
                            `;
                            
                            channelElement.addEventListener('click', () => {
                                selectDMChannel(dmChannel.id, dmChannel.recipient);
                            });
                            
                            channelList.appendChild(channelElement);
                        });
                    } else {
                        console.error('Error loading DM channels:', data.message);
                        document.getElementById('channel-list').innerHTML = `
                            <div class="text-center p-3 text-danger">
                                <small>Error loading DM channels</small>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('channel-list').innerHTML = `
                        <div class="text-center p-3 text-danger">
                            <small>Failed to load DM channels</small>
                        </div>
                    `;
                });
        }
        
        function selectDMChannel(channelId, recipient) {
            // Update active channel
            document.querySelectorAll('.channel-item').forEach(channel => {
                channel.classList.remove('active');
            });
            
            document.querySelector(`.channel-item[data-channel-id="${channelId}"]`).classList.add('active');
            
            // Update channel header
            const channelHeader = document.getElementById('current-channel');
            channelHeader.innerHTML = recipient.username;
            
            // Update channel icon
            const headerIcon = channelHeader.previousElementSibling;
            headerIcon.className = 'bi bi-envelope me-2';
            
            // Update message input
            const messageInput = document.getElementById('message-input');
            messageInput.removeAttribute('disabled');
            messageInput.setAttribute('data-channel-id', channelId);
            messageInput.setAttribute('data-channel-type', 'dm');
            messageInput.setAttribute('data-recipient-id', recipient.id);
            messageInput.placeholder = `Message @${recipient.username}`;
            
            // Enable send button
            document.getElementById('send-button').removeAttribute('disabled');
            
            // Clear message area
            document.getElementById('message-area').innerHTML = '';
            
            // Load messages for this DM channel
            loadMessages(channelId);
            
            // Clear member list (not applicable for DMs)
            document.getElementById('member-list').innerHTML = `
                <div class="text-center p-3 text-muted">
                    <small>Private conversation with ${recipient.username}</small>
                </div>
            `;
        }
        
        // Helper function to create a message element
        function createMessageElement(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            // Add message ID attribute for loading older messages
            if (message.id) {
                messageElement.setAttribute('data-message-id', message.id);
            }
            
            // Create avatar element
            const avatarElement = document.createElement('div');
            if (message.author.avatarUrl) {
                avatarElement.innerHTML = `<img src="${message.author.avatarUrl}" alt="${message.author.username}" width="40" height="40" class="rounded-circle">`;
            } else {
                avatarElement.className = 'message-avatar';
                avatarElement.textContent = message.author.username.charAt(0).toUpperCase();
            }
            
            // Create message content
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            
            // Format timestamp
            const messageDate = new Date(message.timestamp);
            
            // Handle attachments
            let attachmentsHtml = '';
            if (message.attachments && message.attachments.length > 0) {
                message.attachments.forEach(attachment => {
                    if (attachment.url.match(/\.(jpeg|jpg|gif|png)$/i)) {
                        attachmentsHtml += `<div class="mt-2"><img src="${attachment.url}" alt="${attachment.filename}" class="img-fluid rounded" style="max-width: 300px;"></div>`;
                    } else {
                        attachmentsHtml += `<div class="mt-2"><a href="${attachment.url}" target="_blank"><i class="bi bi-file-earmark"></i> ${attachment.filename}</a></div>`;
                    }
                });
            }
            
            contentElement.innerHTML = `
                <div class="message-author">
                    ${message.author.username}
                    <span class="message-timestamp" title="${messageDate.toLocaleDateString()}">${formatTime(messageDate)}</span>
                </div>
                <div class="message-text">${formatMessageContent(message.content)}</div>
                ${attachmentsHtml}
            `;
            
            // If message is pending, add a style
            if (message.pending) {
                messageElement.style.opacity = '0.7';
            }
            
            // Assemble the message
            messageElement.appendChild(avatarElement);
            messageElement.appendChild(contentElement);
            
            return messageElement;
        }
        
        function loadOlderMessages(channelId, beforeMessageId) {
            // Show loading indicator at the top of the message area
            const messageArea = document.getElementById('message-area');
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'text-center p-2 text-muted loading-indicator';
            loadingIndicator.innerHTML = `
                <small><i class="bi bi-arrow-repeat spin"></i> Loading older messages...</small>
            `;
            messageArea.insertBefore(loadingIndicator, messageArea.firstChild);
            
            // Remember the current scroll height to maintain position
            const scrollHeightBefore = messageArea.scrollHeight;
            
            // Fetch older messages
            fetch(`/api/older_messages?channel_id=${channelId}&before_message_id=${beforeMessageId}`)
                .then(response => response.json())
                .then(data => {
                    // Remove loading indicator
                    const loadingEl = document.querySelector('.loading-indicator');
                    if (loadingEl) loadingEl.remove();
                    
                    if (data.status === 'success') {
                        if (data.messages.length === 0) {
                            // No more messages to load
                            const noMoreIndicator = document.createElement('div');
                            noMoreIndicator.className = 'text-center p-2 text-muted';
                            noMoreIndicator.innerHTML = `
                                <small>No more messages</small>
                            `;
                            messageArea.insertBefore(noMoreIndicator, messageArea.firstChild);
                            return;
                        }
                        
                        // Prepend older messages to the top of the message area
                        data.messages.forEach(message => {
                            const messageElement = createMessageElement(message);
                            messageElement.style.opacity = '0';
                            messageArea.insertBefore(messageElement, messageArea.firstChild);
                            
                            // Fade in effect
                            setTimeout(() => {
                                messageElement.style.opacity = '1';
                                messageElement.style.transition = 'opacity 0.3s';
                            }, 10);
                        });
                        
                        // Adjust scroll position to maintain view at the same position
                        const scrollHeightAfter = messageArea.scrollHeight;
                        messageArea.scrollTop = scrollHeightAfter - scrollHeightBefore;
                    } else {
                        console.error('Error loading older messages:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Remove loading indicator
                    const loadingEl = document.querySelector('.loading-indicator');
                    if (loadingEl) loadingEl.remove();
                    
                    // Show error message
                    const errorIndicator = document.createElement('div');
                    errorIndicator.className = 'text-center p-2 text-danger';
                    errorIndicator.innerHTML = `
                        <small>Failed to load older messages</small>
                    `;
                    messageArea.insertBefore(errorIndicator, messageArea.firstChild);
                });
        }
        
        function loadBotInfo() {
            fetch('/api/bot_info')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('bot-username').textContent = data.username;
                        
                        // Update status to online
                        const statusText = document.querySelector('.user-area .d-flex .text-muted');
                        if (statusText) {
                            statusText.textContent = 'Online';
                        }
                        
                        // Update status indicator to online
                        const statusIndicator = document.querySelector('.status-indicator');
                        if (statusIndicator) {
                            statusIndicator.className = 'status-indicator status-online';
                        }
                        
                        // Update avatar if available
                        if (data.avatar_url) {
                            const userArea = document.querySelector('.user-area .d-flex');
                            const avatarElement = document.createElement('img');
                            avatarElement.src = data.avatar_url;
                            avatarElement.alt = data.username;
                            avatarElement.width = 32;
                            avatarElement.height = 32;
                            avatarElement.className = 'rounded-circle me-2';
                            
                            // Replace status indicator with avatar
                            if (statusIndicator) {
                                userArea.replaceChild(avatarElement, statusIndicator);
                            }
                        }
                        
                        // Clear any error messages
                        clearErrorDisplay();
                    } else {
                        console.error('Error loading bot info:', data.message);
                        document.getElementById('bot-username').textContent = 'Bot';
                        
                        // Update status to offline
                        const statusText = document.querySelector('.user-area .d-flex .text-muted');
                        if (statusText) {
                            statusText.textContent = 'Offline';
                        }
                        
                        // Update status indicator to offline
                        const statusIndicator = document.querySelector('.status-indicator');
                        if (statusIndicator) {
                            statusIndicator.className = 'status-indicator status-offline';
                        }
                        
                        // Show error message in a notification
                        showErrorDisplay('Bot Connection Error', 'The bot appears to be offline or initializing. Please check back in a moment.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('bot-username').textContent = 'Bot';
                    
                    // Update status to offline
                    const statusText = document.querySelector('.user-area .d-flex .text-muted');
                    if (statusText) {
                        statusText.textContent = 'Connection Error';
                    }
                    
                    // Update status indicator to error
                    const statusIndicator = document.querySelector('.status-indicator');
                    if (statusIndicator) {
                        statusIndicator.className = 'status-indicator status-dnd';
                    }
                    
                    // Show error in message area
                    showErrorDisplay('Connection Error', 'Could not connect to bot API. Please refresh the page or try again later.');
                });
        }
        
        function loadServers() {
            fetch('/api/guilds')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const serverList = document.getElementById('server-list');
                        serverList.innerHTML = '';
                        
                        data.guilds.forEach(guild => {
                            const serverElement = document.createElement('div');
                            serverElement.className = 'server-icon';
                            serverElement.setAttribute('data-guild-id', guild.id);
                            serverElement.setAttribute('data-bs-toggle', 'tooltip');
                            serverElement.setAttribute('data-bs-placement', 'right');
                            serverElement.setAttribute('title', guild.name);
                            
                            if (guild.icon_url) {
                                serverElement.style.backgroundImage = `url('${guild.icon_url}')`;
                                serverElement.style.backgroundSize = 'cover';
                                serverElement.innerHTML = '';
                            } else {
                                // Create an abbreviation from the guild name
                                const abbr = guild.name.split(' ')
                                    .map(word => word[0])
                                    .slice(0, 2)
                                    .join('');
                                serverElement.textContent = abbr;
                            }
                            
                            serverElement.addEventListener('click', () => {
                                // Remove active state from all servers
                                document.querySelectorAll('.server-icon').forEach(server => {
                                    server.classList.remove('active');
                                });
                                
                                // Add active state to clicked server
                                serverElement.classList.add('active');
                                
                                // Load channels for this server
                                loadChannels(guild.id);
                            });
                            
                            serverList.appendChild(serverElement);
                        });
                        
                        // Reinitialize tooltips
                        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                        tooltipTriggerList.map(function(tooltipTriggerEl) {
                            return new bootstrap.Tooltip(tooltipTriggerEl);
                        });
                    } else {
                        console.error('Error loading servers:', data.message);
                        document.getElementById('server-list').innerHTML = 
                            `<div class="text-center p-3 text-danger">
                                <small>Error loading servers</small>
                            </div>`;
                            
                        // Show error message in the main area
                        if (data.message === 'Bot is not running') {
                            showErrorDisplay('Bot Connection Error', 'The bot appears to be offline or initializing. The LiveBot interface requires an active bot connection to display servers and channels.');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('server-list').innerHTML = 
                        `<div class="text-center p-3 text-danger">
                            <small>Failed to load servers</small>
                        </div>`;
                        
                    // Show error message in the main area
                    showErrorDisplay('Connection Error', 'Could not connect to the bot API. Please check your connection and try again.');
                });
        }
        
        function loadChannels(guildId) {
            fetch(`/api/channels?guild_id=${guildId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const channelList = document.getElementById('channel-list');
                        channelList.innerHTML = '';
                        
                        // Group channels by category
                        const categories = {};
                        const uncategorized = [];
                        
                        data.channels.forEach(channel => {
                            if (channel.type === 4) { // Category type
                                categories[channel.id] = {
                                    name: channel.name,
                                    channels: []
                                };
                            } else if (channel.type === 0) { // Text channel
                                if (channel.parent_id && categories[channel.parent_id]) {
                                    categories[channel.parent_id].channels.push(channel);
                                } else {
                                    uncategorized.push(channel);
                                }
                            }
                        });
                        
                        // Render categories and channels
                        for (const [categoryId, category] of Object.entries(categories)) {
                            const categoryElement = document.createElement('div');
                            categoryElement.className = 'mt-3';
                            categoryElement.innerHTML = `
                                <h6 class="text-uppercase px-3 text-muted fs-6 fw-bold">${category.name}</h6>
                            `;
                            
                            category.channels.forEach(channel => {
                                const channelElement = document.createElement('div');
                                channelElement.className = 'channel-item';
                                channelElement.innerHTML = `
                                    <i class="bi bi-hash me-2"></i> ${channel.name}
                                `;
                                channelElement.setAttribute('data-channel-id', channel.id);
                                
                                channelElement.addEventListener('click', () => {
                                    selectChannel(channel.id, channel.name);
                                });
                                
                                categoryElement.appendChild(channelElement);
                            });
                            
                            channelList.appendChild(categoryElement);
                        }
                        
                        // Render uncategorized channels
                        if (uncategorized.length > 0) {
                            const uncategorizedElement = document.createElement('div');
                            uncategorizedElement.className = 'mt-3';
                            
                            if (Object.keys(categories).length > 0) {
                                uncategorizedElement.innerHTML = `
                                    <h6 class="text-uppercase px-3 text-muted fs-6 fw-bold">Text Channels</h6>
                                `;
                            }
                            
                            uncategorized.forEach(channel => {
                                const channelElement = document.createElement('div');
                                channelElement.className = 'channel-item';
                                channelElement.innerHTML = `
                                    <i class="bi bi-hash me-2"></i> ${channel.name}
                                `;
                                channelElement.setAttribute('data-channel-id', channel.id);
                                
                                channelElement.addEventListener('click', () => {
                                    selectChannel(channel.id, channel.name);
                                });
                                
                                uncategorizedElement.appendChild(channelElement);
                            });
                            
                            channelList.appendChild(uncategorizedElement);
                        }
                        
                        // If no channels were found
                        if (Object.keys(categories).length === 0 && uncategorized.length === 0) {
                            channelList.innerHTML = `
                                <div class="text-center p-3 text-muted">
                                    <small>No text channels available</small>
                                </div>
                            `;
                        }
                    } else {
                        console.error('Error loading channels:', data.message);
                        document.getElementById('channel-list').innerHTML = 
                            `<div class="text-center p-3 text-danger">
                                <small>Error loading channels</small>
                            </div>`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('channel-list').innerHTML = 
                        `<div class="text-center p-3 text-danger">
                            <small>Failed to load channels</small>
                        </div>`;
                });
        }
        
        function selectChannel(channelId, channelName) {
            // Update UI to show the selected channel
            document.querySelectorAll('.channel-item').forEach(channel => {
                channel.classList.remove('active');
            });
            
            document.querySelector(`[data-channel-id="${channelId}"]`).classList.add('active');
            document.getElementById('current-channel').textContent = channelName;
            
            // Enable message input
            const messageInput = document.getElementById('message-input');
            messageInput.disabled = false;
            messageInput.setAttribute('data-channel-id', channelId);
            messageInput.placeholder = `Message #${channelName}`;
            
            document.getElementById('send-button').disabled = false;
            
            // Load messages
            loadMessages(channelId);
            
            // Load members
            loadMembers(channelId);
        }
        
        function loadMessages(channelId) {
            // Show loading indicator
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = `
                <div class="text-center p-4">
                    <div class="mb-3">
                        <i class="bi bi-arrow-repeat spin" style="font-size: 2rem;"></i>
                    </div>
                    <p class="text-muted">Loading messages...</p>
                </div>
            `;
            
            fetch(`/api/messages?channel_id=${channelId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const messageArea = document.getElementById('message-area');
                        messageArea.innerHTML = '';
                        
                        if (data.messages.length === 0) {
                            messageArea.innerHTML = `
                                <div class="text-center p-4">
                                    <p class="text-muted">No messages in this channel</p>
                                </div>
                            `;
                            return;
                        }
                        
                        // Group messages by day
                        let currentDay = null;
                        
                        // Add a message at top indicating more messages can be loaded if there are enough messages
                        if (data.messages.length >= 50) {
                            const loadMoreElement = document.createElement('div');
                            loadMoreElement.className = 'text-center p-2 text-muted';
                            loadMoreElement.innerHTML = `
                                <small>Scroll to top to load older messages</small>
                            `;
                            messageArea.appendChild(loadMoreElement);
                        }
                        
                        data.messages.forEach(message => {
                            const messageDate = new Date(message.timestamp);
                            const messageDay = messageDate.toDateString();
                            
                            // Add date separator if this is a new day
                            if (messageDay !== currentDay) {
                                currentDay = messageDay;
                                
                                const dateSeparator = document.createElement('div');
                                dateSeparator.className = 'text-center my-3';
                                dateSeparator.innerHTML = `
                                    <div class="date-separator">
                                        <span class="badge rounded-pill bg-secondary">
                                            ${formatDate(messageDate)}
                                        </span>
                                    </div>
                                `;
                                
                                messageArea.appendChild(dateSeparator);
                            }
                            
                            // Add the message
                            addMessage(message, messageArea);
                        });
                        
                        // Scroll to bottom
                        messageArea.scrollTop = messageArea.scrollHeight;
                    } else {
                        console.error('Error loading messages:', data.message);
                        document.getElementById('message-area').innerHTML = 
                            `<div class="text-center p-4">
                                <p class="text-danger">Error loading messages</p>
                            </div>`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('message-area').innerHTML = 
                        `<div class="text-center p-4">
                            <p class="text-danger">Failed to load messages</p>
                        </div>`;
                });
        }
        
        function loadMembers(channelId) {
            // First, get the guild ID from the channel
            fetch(`/api/channel_info?channel_id=${channelId}`)
                .then(response => response.json())
                .then(channelData => {
                    if (channelData.status === 'success') {
                        // Now get the members for this guild
                        fetch(`/api/members?guild_id=${channelData.guild_id}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    const memberList = document.getElementById('member-list');
                                    memberList.innerHTML = '';
                                    
                                    // Group members by role
                                    const roleGroups = {};
                                    
                                    data.members.forEach(member => {
                                        const roleId = member.highest_role_id || 'online';
                                        const roleName = member.highest_role_name || 'Online';
                                        
                                        if (!roleGroups[roleId]) {
                                            roleGroups[roleId] = {
                                                name: roleName,
                                                members: []
                                            };
                                        }
                                        
                                        roleGroups[roleId].members.push(member);
                                    });
                                    
                                    // Sort roles by position (admins first)
                                    const sortedRoles = Object.entries(roleGroups).sort((a, b) => {
                                        // Prioritize roles with specific IDs (non-default)
                                        if (a[0] === 'online' && b[0] !== 'online') return 1;
                                        if (a[0] !== 'online' && b[0] === 'online') return -1;
                                        return 0;
                                    });
                                    
                                    // Render role groups
                                    sortedRoles.forEach(([roleId, role]) => {
                                        const roleElement = document.createElement('div');
                                        roleElement.className = 'mt-2';
                                        roleElement.innerHTML = `
                                            <h6 class="text-uppercase px-3 text-muted fs-6 fw-bold">${role.name} — ${role.members.length}</h6>
                                        `;
                                        
                                        // Sort members by name
                                        role.members.sort((a, b) => a.username.localeCompare(b.username));
                                        
                                        role.members.forEach(member => {
                                            const memberElement = document.createElement('div');
                                            memberElement.className = 'member-item';
                                            
                                            // Determine status class
                                            let statusClass = 'status-offline';
                                            if (member.status === 'online') statusClass = 'status-online';
                                            else if (member.status === 'idle') statusClass = 'status-idle';
                                            else if (member.status === 'dnd') statusClass = 'status-dnd';
                                            
                                            if (member.avatar_url) {
                                                memberElement.innerHTML = `
                                                    <div class="status-indicator ${statusClass}"></div>
                                                    <img src="${member.avatar_url}" alt="${member.username}" width="24" height="24" class="rounded-circle me-2">
                                                    <span>${member.nick || member.username}</span>
                                                `;
                                            } else {
                                                memberElement.innerHTML = `
                                                    <div class="status-indicator ${statusClass}"></div>
                                                    <div class="rounded-circle me-2 d-flex align-items-center justify-content-center" 
                                                        style="width: 24px; height: 24px; background-color: #7289da; color: white; font-size: 10px;">
                                                        ${member.username.charAt(0)}
                                                    </div>
                                                    <span>${member.nick || member.username}</span>
                                                `;
                                            }
                                            
                                            roleElement.appendChild(memberElement);
                                        });
                                        
                                        memberList.appendChild(roleElement);
                                    });
                                    
                                    // If no members were found
                                    if (sortedRoles.length === 0) {
                                        memberList.innerHTML = `
                                            <div class="text-center p-3 text-muted">
                                                <small>No members found</small>
                                            </div>
                                        `;
                                    }
                                } else {
                                    console.error('Error loading members:', data.message);
                                    document.getElementById('member-list').innerHTML = 
                                        `<div class="text-center p-3 text-danger">
                                            <small>Error loading members</small>
                                        </div>`;
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                document.getElementById('member-list').innerHTML = 
                                    `<div class="text-center p-3 text-danger">
                                        <small>Failed to load members</small>
                                    </div>`;
                            });
                    } else {
                        console.error('Error getting channel info:', channelData.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        function addMessage(message, container = null) {
            const messageArea = container || document.getElementById('message-area');
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            // Add message ID attribute for loading older messages
            if (message.id) {
                messageElement.setAttribute('data-message-id', message.id);
            }
            
            // Create avatar
            const avatarElement = document.createElement('div');
            if (message.author.avatarUrl) {
                avatarElement.innerHTML = `<img src="${message.author.avatarUrl}" alt="${message.author.username}" width="40" height="40" class="rounded-circle">`;
            } else {
                avatarElement.className = 'message-avatar';
                avatarElement.textContent = message.author.username.charAt(0).toUpperCase();
            }
            
            // Create message content with author and timestamp
            const messageDate = new Date(message.timestamp);
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            
            // Build content HTML (including any attachments)
            let contentHtml = `
                <div class="message-author">
                    ${message.author.username}
                    <span class="message-timestamp" title="${messageDate.toLocaleDateString()}">${formatTime(messageDate)}</span>
                </div>
                <div class="message-text">${formatMessageContent(message.content)}</div>
            `;
            
            // Add any attachments
            if (message.attachments && message.attachments.length > 0) {
                let attachmentsHtml = '';
                
                message.attachments.forEach(attachment => {
                    if (attachment.url.match(/\.(jpeg|jpg|gif|png)$/i)) {
                        attachmentsHtml += `<div class="mt-2"><img src="${attachment.url}" alt="${attachment.filename}" class="img-fluid rounded" style="max-width: 300px;"></div>`;
                    } else {
                        attachmentsHtml += `<div class="mt-2"><a href="${attachment.url}" target="_blank"><i class="bi bi-file-earmark"></i> ${attachment.filename}</a></div>`;
                    }
                });
                
                contentHtml += attachmentsHtml;
            }
            
            contentElement.innerHTML = contentHtml;
            
            // If message is pending, add a style
            if (message.pending) {
                messageElement.style.opacity = '0.7';
            }
            
            // Assemble the message
            messageElement.appendChild(avatarElement);
            messageElement.appendChild(contentElement);
            
            // Add to message area
            messageArea.appendChild(messageElement);
            
            // Scroll to bottom
            messageArea.scrollTop = messageArea.scrollHeight;
            
            return messageElement;
        }
        
        function formatMessageContent(content) {
            if (!content) return '';
            
            // Replace URLs with clickable links
            content = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
            
            // Replace Discord mentions with styled text
            content = content.replace(/<@!?(\d+)>/g, '<span class="badge bg-secondary">@user</span>');
            content = content.replace(/<#(\d+)>/g, '<span class="badge bg-secondary">#channel</span>');
            
            // Replace newlines with <br>
            content = content.replace(/\n/g, '<br>');
            
            return content;
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function formatDate(date) {
            // Check if date is today
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                // Format as Month Day, Year
                return date.toLocaleDateString(undefined, {
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });
            }
        }
        
        function showNotification(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            
            const notificationElement = document.createElement('div');
            notificationElement.className = `alert alert-${type} alert-dismissible fade show`;
            notificationElement.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            messageArea.appendChild(notificationElement);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                notificationElement.remove();
            }, 5000);
        }
    </script>
</body>
</html>